#### задание
**Backend for frontends. Apigateway**
Реализовать сценарий "Изменение и просмотр данных в профиле клиента".
Пользователь регистрируется. Заходит под собой и по определенному урлу получает данные о своем профиле. Может поменять данные в профиле. Данные профиля для чтения и редактирования не должны быть доступны другим клиентам (аутентифицированным или нет).

На выходе должны быть
1. описание архитектурного решения и схема взаимодействия сервисов (в виде картинки)
2. команда установки приложения (из helm-а или из манифестов). Обязательно указать в каком namespace нужно устанавливать.
* команда установки api-gateway, если он отличен от nginx-ingress.
3. тесты постмана, которые прогоняют сценарий:
* регистрация пользователя 1
* проверка, что изменение и получение профиля пользователя недоступно без логина
* вход пользователя 1
* изменение профиля пользователя 1
* проверка, что профиль поменялся
* выход* (если есть)
* регистрация пользователя 2
* вход пользователя 2
* проверка, что пользователь2 не имеет доступа на чтение и редактирование профиля пользователя1.

В тестах обязательно
* наличие {{baseUrl}} для урла
* использование домена arch.homework в качестве initial значения {{baseUrl}}
* использование сгенерированных случайно данных в сценарии
* отображение данных запроса и данных ответа при запуске из командной строки с помощью newman.

#### что делал
домашнее задание сделано на основе [предыдущего](https://github.com/turneps403/otus-homework/tree/HWA-03)
- в код основного приложения добавлен контроллер логина, позволяющий проверять есть ли юзер с уазанными логином и паролем
- написано приложение для работы с JWT, реализующее два интерфеса: `login` для выдачи JWT если юзер был уатентифицирован 
по логину и паролю и, `auth` который на основе проверки JWT добавляет заголовок в ответ
- в `helmfile` добавлены релизы для *Traefik* 2.x и JWT сервиса
- написаны тесты для Postman

![](myFiles/simple-graph.png)

#### мой доп github код для домашки
- [traefik + middleware](https://github.com/turneps403/helmfile-traefik-v2-minikube)
- [app for jwt](https://github.com/turneps403/java-crumbs/tree/jwt-middleware)

#### ньюансы
я так и не смог найти решения, как заэкспозить Traefik на minikube на 80 порт.
поэтому, прописать minikube ip в `/etc/hosts` не является решением.
в тестах Postman я учел эту особенность.

#### Запуск & Проверка
чекаутим проект
```
$ git clone --single-branch --branch HWA-05 https://github.com/turneps403/otus-homework.git HWA-05
$ cd HWA-05
``` 
запускаем Helm манифесты
```
$ cd cd hwHelmFile
$ helmfile sync
```
запрашивем у мини-кубика урлы для Traefik
```
$ minikube service mytraefik --namespace=traefikns --url
> http://192.168.64.28:30926
> http://192.168.64.28:32675
```
![](myFiles/services.png)
забираем ip и port для запуска тестов Postman
```
$ newman run OTUS-HWA-05.postman_collection.json --global-var "traefikMinikube=192.168.64.28:30282"
```
![](myFiles/postman.png)
![](myFiles/newman.png)
выключаем Helm манифесты
```
$ helmfile destroy
```

#### Knoweledge
* https://medium.com/better-programming/k8s-tips-using-a-serviceaccount-801c433d0023
* https://www.istiobyexample.dev/response-headers/